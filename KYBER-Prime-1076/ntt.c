#include <stdint.h>
#include "params.h"
#include "ntt.h"
#include "reduce.h"

#define ROOT_3 2569925

static const int32_t zetas[N_PRIME] = {
299204, -299204, 624921, -299204, -1172445, -2820848, 624921, -299204, -2318414, -2290279, 231677, 594572, -1172445, -2820848, 624921, -299204,
91169, 2713923, -2875035, -2067341, 1678832, -2886866, -2636951, 2636044, -2318414, -2290279, 231677, 594572, -1172445, -2820848, 624921, -299204,       
3087332, -172406, -649469, -287669, -25909, -2351475, 2630653, -77336, 2998316, -1512640, 1714275, -2909074, -2119361, 1589788, -1442639, -74756,        
91169, 2713923, -2875035, -2067341, 1678832, -2886866, -2636951, 2636044, -2318414, -2290279, 231677, 594572, -1172445, -2820848, 624921, -299204,       
-1279539, -3471732, 1714275, -2886866, -2624404, 1149563, 1974683, 3471732, 2998316, 1678832, -1448096, -3726485, 1869507, -2047653, -1512640, -1678832, 
-505218, -3516249, 1084570, 879298, -2119361, -2636951, 1651562, 3516249, 447913, 708349, -1442639, 2636044, 3111902, 3344393, 3037146, -708349,
3087332, 91169, 325435, -3309451, -1492030, -3218282, -172406, -91169, -3358971, -3562866, -3646640, -1231372, -649469, 2713923, -2331204, 3562866,      
2149082, 3525621, 2630653, -2067341, 3469988, 1458280, 3392652, -3525621, -25909, -2875035, 926369, 1161639, -318245, -1713396, -2351475, 2875035,       
-3471732, -720954, 1149563, 952631, 1678832, 231677, -2047653, 720954, -3516249, 2197548, -2636951, 594572, 708349, 2792120, 3344393, -2197548,
91169, -2318414, -3218282, 1189583, -3562866, -1128831, 2713923, 2318414, 3525621, -1661526, 1458280, -628753, -2875035, -2290279, -1713396, 1661526,    
-720954, -970729, 231677, -2820848, 2197548, 3716584, 2792120, 970729, -2318414, -1172445, -1128831, -2049972, -1661526, -3222417, -2290279, 1172445,    
-970729, 2259555, 3716584, -1634634, -1172445, 624921, -3222417, -2259555, 2259555, 2869129, 624921, -299204, 2869129, 2569925, 2569925, -2869129,       
-2414818, -1629197, -520860, -750571, -3646640, -1231372, -3358971, -3562866, -1518169, -347183, -702292, 1009834, -3724587, -1009834, -649469, 2713923, 
-173566, 1629197, 2683803, -1976380, 16386, 259263, -2331204, 3562866, 3087332, 91169, 255819, -3609307, -256171, -2165812, 2280129, 412842,
325435, -3309451, 77849, 1641088, -2462768, -1641088, -2964030, -1752970, -172406, -91169, -1492030, -3218282, -3109651, -1968219, -2977648, -412842,
812044, 2058556, 3469988, 1458280, 1468868, 2017333, 1682530, 2926237, 712217, 3652632, 3392652, -3525621, 2149082, 3525621, 1836001, -2564591,
3079716, -2058556, -2753947, -1796973, 2630653, -2067341, 1449887, -2926237, 1775169, 1681425, 2296041, 541479, 926369, 1161639, -25909, -2875035,
-3640689, 3737374, -1574786, 2516222, -1415918, -2516222, -318245, -1713396, -2420389, -1681425, 3345703, -2089362, -643842, 3057701, -2351475, 2875035,
-1279539, -3471732, -819626, -1838516, -2440798, -1671014, 587913, -723141, 1714275, -2886866, -2602666, -1968432, -1763398, 1968432, 2473529, -2394155,
1974683, 3471732, -2624404, 1149563, -854333, 3701213, 220532, 723141, -2142122, 3101187, 1869507, -2047653, -579175, -90232, -1124717, -2702280,
-93178, -3209988, -1512640, -1678832, 2998316, 1678832, 812319, -2792512, 1135253, -3101187, -2896781, -108801, -1448096, -3726485, -3702129, 2702280,
1628347, 3523316, -1506762, -1445556, -1442639, 2636044, 447913, 708349, -760720, 670693, 87726, 320021, 696412, -320021, 3111902, 3344393,
521247, -3523316, -985574, -3314152, 238371, -1125535, 3037146, -708349, -505218, -3516249, -2801101, -812701, -2202129, 104168, 1208341, 3317343,
1084570, 879298, 1843165, 2401432, -2052113, -2401432, -837956, 3421511, 1651562, 3516249, -2119361, -2636951, 19708, 1588731, -2003791, -3317343,
-1629197, 3611967, -3562866, -1128831, -750571, -1616351, -1009834, 2568119, -1976380, 296917, 2713923, 2318414, 91169, -2318414, 412842, 951768,
-3609307, -3611967, -1641088, -3599277, -3218282, 1189583, -1752970, -2568119, 2058556, 1534591, 2926237, 3618049, 1458280, -628753, 3525621, -1661526,
-1796973, -2107595, -2564591, -3090549, 1681425, 3090549, -2875035, -2290279, 541479, -1534591, -2516222, -573004, -2089362, 527500, -1713396, 1661526,
-3471732, -720954, -723141, -512124, -1838516, 824873, 1968432, -65736, 1149563, 952631, -2394155, 1441388, 3101187, -1441388, -2702280, 759137,
-2047653, 720954, 1678832, 231677, -108801, 929264, -2792512, 65736, 3523316, -3606872, 708349, 2792120, -1445556, -1708516, -320021, -92865,
-3314152, 2413135, 3344393, -2197548, -3516249, 2197548, 3317343, -1801381, -812701, 3606872, -2401432, -1193737, -2636951, 594572, 3421511, 92865,
3611967, -3703751, 2568119, 2267973, -1128831, -2049972, -2318414, -1172445, -3599277, -1175506, 951768, -2360463, 1534591, 2360463, -1661526, -3222417,
3618049, 3703751, 3090549, 2628904, -573004, -92490, -2290279, 1172445, -720954, -970729, -65736, 2475139, -512124, 1088354, -1441388, -3616613,
231677, -2820848, 759137, -3253409, -3606872, 3253409, -92865, -2528259, 2792120, 970729, 2197548, 3716584, -1193737, -778270, -1801381, 3616613,
-3703751, -1779874, -1172445, 624921, 2267973, -1009061, 2360463, -2621893, 2628904, -1780273, -3222417, -2259555, -970729, 2259555, -3616613, -3630954,
2475139, 1779874, 3253409, -3560147, 3716584, -1634634, -2528259, 2621893, -1779874, 873023, -2621893, -1864892, 624921, -299204, 2259555, 2869129,
-3560147, 986562, -3630954, -3402795, 873023, 3402795, 2869129, 2569925, -1864892, -873023, 3402795, 1859585, 1859585, 2240474, 2569925, -2869129
};

static const int32_t zetas_inv[N_PRIME] = {
1165835, -104168, -2071821, 812701, -1651562, 3516249, 3737238, -879298, 2003791, -3317343, -19708, 1588731, 2863895, -1588731, -1589788, 2636951,
2202129, 104168, 3410470, -3421511, -1843165, 2401432, -1084570, 879298, 74756, -2636044, 458041, 1445556, -521247, -3523316, -1506821, -670693,
-3037146, -708349, -238371, -1125535, -1594488, 1125535, 2389067, 3314152, 1442639, 2636044, 1890552, -3344393, -87726, 320021, 760720, 670693,
-2993713, 90232, -3061749, 2047653, -1135253, -3101187, 3476127, 3209988, 3702129, 2702280, 1448096, -3726485, 3382147, 3726485, -2048944, 108801,
579175, -90232, -545542, 2792512, 1512640, -1678832, 93178, -3209988, 2252997, 1671014, -909065, 1838516, -1974683, 3471732, 2909074, 2886866,
-220532, 723141, 854333, 3701213, 1783040, -3701213, -2993814, -1149563, 2440798, -1671014, 3028711, 2394155, 2602666, -1968432, -1714275, -2886866,
2033230, -1161639, -772076, -541479, 2420389, -1681425, -1742069, -3737374, 2351475, 2875035, 643842, 3057701, -3637334, -3057701, -2092303, 2089362,
-926369, 1161639, -952278, 1713396, 1574786, 2516222, 3640689, 3737374, 386114, -2017333, -481571, -1458280, -3079716, -2058556, 1674498, -3652632,
-1449887, -2926237, -2630653, -2067341, 77336, 2067341, 99827, 1796973, -1468868, 2017333, 213662, 2564591, -3392652, -3525621, -712217, 3652632,
13618, 2165812, 646883, 3609307, 172406, -91169, -1319624, 3309451, 2977648, -412842, 3109651, -1968219, 177970, 1968219, 2761897, 3218282,
256171, -2165812, 2536300, 1752970, -77849, 1641088, -325435, -3309451, 1681735, 1231372, -3740973, 750571, 173566, 1629197, 2857369, 347183,
2331204, 3562866, -16386, 259263, 181432, -259263, -896649, 1976380, 3646640, -1231372, 287669, -2713923, 702292, 1009834, 1518169, -347183,
-104168, 1708516, -879298, -2792120, 812701, 3606872, -1588731, -2413135, -3421511, 92865, 2636951, 594572, -2636044, -594572, -670693, 1193737,
1445556, -1708516, 1125535, 1801381, -3344393, -2197548, 3314152, 2413135, 90232, -824873, 3209988, 512124, 2047653, 720954, 3726485, -952631,
2792512, 65736, 108801, 929264, 1671014, -929264, 2886866, -231677, 1838516, 824873, -3701213, -759137, 2394155, 1441388, -1149563, 952631,
-1161639, 628753, -3737374, -3618049, -541479, -1534591, -3057701, 2107595, 1713396, 1661526, 2089362, 527500, -2017333, -527500, -3652632, 573004,
-1458280, -628753, 2067341, 2290279, 2564591, -3090549, 1796973, -2107595, 2165812, 1616351, 3309451, 1128831, 3609307, -3611967, 1968219, -296917,
1752970, -2568119, 3218282, 1189583, 1231372, -1189583, 347183, 3599277, 750571, -1616351, -259263, -951768, -2713923, 2318414, 1976380, 296917,
1708516, -1088354, -2413135, -2475139, -2792120, 970729, -594572, 2820848, 1801381, 3616613, 1193737, -778270, -824873, 778270, -952631, -3716584,
512124, 1088354, -929264, 2528259, -759137, -3253409, -231677, -2820848, 628753, 2049972, 2107595, -2267973, -3618049, 3703751, -527500, 1175506,
2290279, 1172445, 573004, -92490, 1616351, 92490, -296917, -2628904, 1128831, -2049972, -1189583, 3222417, -951768, -2360463, 3599277, -1175506,
-1088354, 1009061, 2820848, -624921, -2475139, 1779874, 778270, 1780273, 2528259, 2621893, -3716584, -1634634, 2049972, 1634634, 1175506, 3560147,
-2267973, -1009061, 92490, 3630954, 3222417, -2259555, -2628904, -1780273, 1009061, -2240474, 1780273, -1859585, -624921, -299204, 1634634, -2569925, 
3630954, -3402795, 3560147, 986562, -2240474, -986562, -2569925, -2869129, -1859585, 2240474, -986562, 1864892, 1864892, -873023, -2869129, 2569925,
2033230, -1161639, 2351475, 2875035, -952278, 1713396, -926369, 1161639, 77336, 2067341, -3392652, -3525621, -481571, -1458280, -2630653, -2067341,
1681735, 1231372, 2331204, 3562866, 287669, -2713923, 3646640, -1231372, -1319624, 3309451, 172406, -91169, 2761897, 3218282, -325435, -3309451,
74756, -2636044, -3037146, -708349, 1890552, -3344393, 1442639, 2636044, 3737238, -879298, -1651562, 3516249, -1589788, 2636951, -1084570, 879298,
3382147, 3726485, 1512640, -1678832, -3061749, 2047653, 1448096, -3726485, 2909074, 2886866, -1974683, 3471732, -2993814, -1149563, -1714275, -2886866,
-1161639, 628753, 1713396, 1661526, 2067341, 2290279, -1458280, -628753, 1231372, -1189583, -2713923, 2318414, 3309451, 1128831, 3218282, 1189583,
-2636044, -594572, -3344393, -2197548, -879298, -2792120, 2636951, 594572, 3726485, -952631, 2047653, 720954, 2886866, -231677, -1149563, 952631,
628753, 2049972, 2290279, 1172445, -1189583, 3222417, 1128831, -2049972, -594572, 2820848, -2792120, 970729, -952631, -3716584, -231677, -2820848,
2049972, 1634634, 3222417, -2259555, 2820848, -624921, -3716584, -1634634, 1634634, -2569925, -624921, -299204, -2569925, -2869129, -2869129, 2569925,
74756, 1442639, -1589788, 2119361, 2909074, -1714275, 1512640, -2998316, 77336, -2630653, 2351475, 25909, 287669, 649469, 172406, -3087332,
-2636044, 2636951, 2886866, -1678832, 2067341, 2875035, -2713923, -91169, -594572, -231677, 2290279, 2318414, 2820848, 1172445, -624921, -299204,
-2636044, 2636951, 2886866, -1678832, 2067341, 2875035, -2713923, -91169, -594572, -231677, 2290279, 2318414, 2820848, 1172445, -624921, -299204,
-594572, -231677, 2290279, 2318414, 2820848, 1172445, -624921, -299204, 2820848, 1172445, -624921, -299204, -624921, -299204, -2547433, 2547433
};

/*************************************************
* Name:        poly_reduction
*
* Description: Switching back to Zq[x]/(x^n-x-1).
**************************************************/
static void poly_reduction(int16_t r[KYBER_N], const int32_t a[N_PRIME])
{
  unsigned int i;
  int32_t tmp[269];

  tmp[0] = a[0] + a[269];
  for(i = 1; i < 268; i++)
    tmp[i] = a[i + 268] + a[i + 269] + a[i];
  tmp[268] = a[268] + a[536];

  for(i = 0; i < 269; ++i)
      r[i] = reduce32to16(tmp[i]);
}

/*************************************************
* Name:        poly_padding
*
* Description: zero padding.
**************************************************/
static void poly_padding(int32_t r[N_PRIME], const int16_t a[KYBER_N])
{
  unsigned int i;
  for(i=0;i<269;i++){
    r[i]=a[i];
  }
  for(i=269;i<576;i++){
    r[i]=0;
  }

}

/*************************************************
* Name:        ntt_naive
*
* Description: Inplace number-theoretic transform (NTT) in R_Q.
**************************************************/
static void ntt_naive(int32_t r[N_PRIME]) {
  unsigned int len, start, j, k;
  int32_t t, zeta;
  int32_t tb, tc, tpho, zeta1, zeta2;

  // Radix-2
  k = 1;
  for(len = 288; len >= 9; len >>= 1) {
    for(start = 0; start < 576; start = j + len) {
      zeta = zetas[k++];
      for(j = start; j < start + len; j++) {
        t = fQmul(zeta, r[j + len]);
        r[j + len] = r[j] - t;
        r[j] = r[j] + t;
      }
    }
  }
  
  // Radix-3
  len = 3;
  for (start = 0; start < 576; start += 3 * len)
  {
    zeta1 = zetas[k++];
    zeta2 = zetas[k++];
    for (j = start; j < start + len; j++)
    {
      tb = fQmul(zeta1, r[j + len]);
      tc = fQmul(zeta2, r[j + len + len]);
      tpho = fQmul(ROOT_3, tb - tc);

      r[j + len + len] = r[j] - tb - tpho;
      r[j + len] = r[j] - tc + tpho;
      r[j] = r[j] + tb + tc;
    }
  }

  // Radix-3
  len = 1;
  for (start = 0; start < 576; start += 3 * len)
  {
    zeta1 = zetas[k++];
    zeta2 = zetas[k++];
    for (j = start; j < start + len; j++)
    {
      tb = fQmul(zeta1, r[j + len]);
      tc = fQmul(zeta2, r[j + len + len]);
      tpho = fQmul(ROOT_3, tb - tc);

      r[j + len + len] = r[j] - tb - tpho;
      r[j + len] = r[j] - tc + tpho;
      r[j] = r[j] + tb + tc;
    }
  }
}

/*************************************************
* Name:        invtntt_naive
*
* Description: Inplace inverse number-theoretic transform in R_Q.
**************************************************/
static void invtntt_naive(int32_t r[N_PRIME]) {
  unsigned int start, len, j, k;
  int32_t t, zeta;
  int32_t tb, tc, tpho, zeta1, zeta2;

  k = 0;

  // Radix-3
  len = 1;
  for (start = 0; start < 576; start += 3 * len)
  {
    zeta1 = zetas_inv[k++];
    zeta2 = zetas_inv[k++];
    for (j = start; j < start + len; j++)
    {
      tpho = fQmul(ROOT_3, r[j + len] - r[j + len + len]);
      tb = (r[j] - r[j + len] - tpho);
      tc = (r[j] - r[j + len + len] + tpho);

      r[j] = (r[j] + r[j + len] + r[j + len + len]);
      r[j + len] = fQmul(zeta1, tb);
      r[j + len + len] = fQmul(zeta2, tc);
    }
  }

  // Radix-3
  len = 3;
  for (start = 0; start < 576; start += 3 * len)
  {
    zeta1 = zetas_inv[k++];
    zeta2 = zetas_inv[k++];
    for (j = start; j < start + len; j++)
    {
      tpho = fQmul(ROOT_3, r[j + len] - r[j + len + len]);
      tb = (r[j] - r[j + len] - tpho);
      tc = (r[j] - r[j + len + len] + tpho);

      r[j] = (r[j] + r[j + len] + r[j + len + len]);
      r[j + len] = fQmul(zeta1, tb);
      r[j + len + len] = fQmul(zeta2, tc);
    }
  }
  
  // Radix-2
  for(len = 9; len <= 288; len <<= 1) {
    for(start = 0; start < 576; start = j + len) {
      zeta = zetas_inv[k++];
      for(j = start; j < start + len; j++) {
        t = r[j];
        r[j] = t + r[j + len];
        r[j + len] = t - r[j + len];
        r[j + len] = fQmul(zeta, r[j + len]);
      }
    }
  }

  for(j = 0; j < 288; j++)
    r[j] = fQmul(r[j], zetas_inv[575]);
}

/*************************************************
* Name:        ntt
*
* Description: The complete extended NTT.
**************************************************/
void ntt(int32_t a_star[N_PRIME], int16_t a[KYBER_N]){
  poly_padding(a_star, a);
  ntt_naive(a_star);
}

/*************************************************
* Name:        invntt
*
* Description: The complete inverse extended NTT.
**************************************************/
void invntt(int16_t a[KYBER_N], int32_t a_star[N_PRIME]){
  invtntt_naive(a_star);
  poly_reduction(a, a_star);
}

/*************************************************
* Name:        poly_pointwise
*
* Description: Multiplication in Zq[X]/(x-zeta)
**************************************************/
void poly_pointwise(int32_t c[N_PRIME], const int32_t a[N_PRIME], const int32_t b[N_PRIME])
{
  unsigned int i;
  for(i = 0; i < 576; ++i)
    c[i] = fQmul(a[i], b[i]);
}
