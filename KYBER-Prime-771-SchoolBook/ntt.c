#include <stdint.h>
#include "params.h"
#include "ntt.h"
#include "reduce.h"

#define ROOT_3 1956604

static const int32_t zetas[N_PRIME] = {
2275189, 749964, -149679, 749964, 946508, -1336474, -149679, 749964, 918587, 167662, -626660, 1242365, 946508, -1336474, -149679, 749964,    
-255899, -320651, 1089533, -131705, 292424, -1108725, -482795, 1087418, 918587, 167662, -626660, 1242365, 946508, -1336474, -149679, 749964, 
-129467, -44826, -636460, 971569, 1048107, -31764, -510118, -335581, 1321859, -821743, -190176, -120873, -500381, 339709, -114514, -62571,   
-255899, -320651, 1089533, -131705, 292424, -1108725, -482795, 1087418, 918587, 167662, -626660, 1242365, 946508, -1336474, -149679, 749964, 
1209967, -625971, -190176, -1108725, -1031782, 1290457, -1152655, 625971, 1321859, 292424, 184968, 799818, 912665, 1092242, -821743, -292424,
1465081, -756766, -1220363, 273971, -500381, -482795, -353619, 756766, -727464, -540966, -114514, 1087418, -638401, 546452, -700972, 540966,
-129467, -255899, 811443, -298714, -32530, -554613, -44826, 255899, 385144, 954259, 1356713, -1274910, -636460, -320651, 1502727, -954259,
463809, -1052566, -510118, -131705, -241737, -1184271, -577318, 1052566, 1048107, 1089533, -1305047, -999472, -88243, 90061, -31764, -1089533,
-625971, 610714, 1290457, -1237374, 292424, -626660, 1092242, -610714, -756766, 739403, -482795, 1242365, -540966, -1043385, 546452, -739403,
-255899, 918587, -554613, 22289, 954259, 940876, -320651, -918587, -1052566, 1405401, -1184271, -1237739, 1089533, 167662, 90061, -1405401,
610714, 344601, -626660, -1336474, 739403, -991873, -1043385, -344601, 918587, 946508, 940876, -787566, 1405401, 158942, 167662, -946508,
344601, -1486967, -991873, 1337288, 946508, -149679, 158942, 1486967, -1486967, 1206640, -149679, 749964, 1206640, -1068549, -1068549, -1206640,
1190377, 67782, 666040, -1126122, 1356713, -1274910, 385144, 954259, 338944, 950557, 987543, 118735, -593833, -118735, -636460, -320651,
1170664, -67782, 512382, 1018339, -612217, -1007387, 1502727, -954259, -129467, -255899, 1302845, -727428, 229333, 771538, 1205584, -959388,
811443, -298714, 1106208, -875155, 1121776, 875155, 634950, -187850, -44826, 255899, -32530, -554613, 653780, 1422570, -1102136, 959388,
982485, -1232509, -241737, -1184271, -1076620, 770339, -407692, 150960, -852936, -57810, -577318, 1052566, 463809, -1052566, -313948, 921299,
-639925, 1232509, 594339, -1290319, -510118, -131705, -787303, -150960, 894513, -1482296, -46256, -43158, -1305047, -999472, 1048107, 1089533,
-742229, 1109168, 106628, 662184, -1188078, -662184, -88243, 90061, -75270, 1482296, -9677, -373128, 679924, 619026, -31764, -1089533,
1209967, -625971, 624779, -686708, 1335985, -76093, -314347, -1432923, -190176, -1108725, -421287, 922966, 749320, -922966, -32461, -1509016,
-1152655, 625971, -1031782, 1290457, 1212037, 236258, 884483, 1432923, -1064361, 483803, 912665, 1092242, 1389328, 859842, 104988, 774010,
71658, -71564, -821743, -292424, 1321859, 292424, 405169, -1391301, -1489139, -483803, -365033, 412239, 184968, 799818, 241389, -774010,
-1272415, 1226465, 1483987, 419476, -114514, 1087418, -727464, -540966, 1038359, -1193594, -702549, 612191, 623719, -612191, -638401, 546452,
-98777, -1226465, -1383081, 32871, 1041936, 1031667, -700972, 540966, 1465081, -756766, -1276416, 1298588, 87625, 1332708, 224477, -217773,
-1220363, 273971, -719009, -443383, 53698, 443383, -312924, 1114935, -353619, 756766, -500381, -482795, -670529, 855205, -762457, 217773,
67782, 202450, 954259, 940876, -1126122, 1267696, -118735, -1169182, 1018339, 561962, -320651, -918587, -255899, 918587, -959388, 98514,
-727428, -202450, 875155, 764412, -554613, 22289, -187850, 1169182, -1232509, 688234, 150960, -1135274, -1184271, -1237739, -1052566, 1405401,
-1290319, 1038706, 921299, 283970, -1482296, -283970, 1089533, 167662, -43158, -688234, -662184, -1298213, -373128, -851304, 90061, -1405401,
-625971, 610714, -1432923, -942066, -686708, 592820, -922966, 623605, 1290457, -1237374, -1509016, 193700, 483803, -193700, 774010, 1216425,
1092242, -610714, 292424, -626660, 412239, -748366, -1391301, -623605, 1226465, 1176706, -540966, -1043385, 419476, -869534, -612191, 950096,
32871, -690882, 546452, -739403, -756766, 739403, -217773, 80562, 1298588, -1176706, 443383, 485824, -482795, 1242365, 1114935, -950096,
202450, 1112937, -1169182, -888508, 940876, -787566, 918587, 946508, 764412, -384107, 98514, -793758, 688234, 793758, 1405401, 158942,
-1135274, -1112937, -283970, 728830, -1298213, 1342887, 167662, -946508, 610714, 344601, 623605, -1253171, -942066, 654845, -193700, 1381607,
-626660, -1336474, 1216425, -573935, 1176706, 573935, 950096, -988701, -1043385, -344601, 739403, -991873, 485824, 1198047, 80562, -1381607,
1112937, 131829, 946508, -149679, -888508, 831042, 793758, -796061, 728830, -259660, 158942, 1486967, 344601, -1486967, 1381607, 34981,
-1253171, -131829, 573935, -127831, -991873, 1337288, -988701, 796061, 131829, -320826, -796061, 917624, -149679, 749964, -1486967, 1206640,
-127831, 985567, 34981, 1258397, -320826, -1258397, 1206640, -1068549, 917624, 320826, -1258397, 664741, 664741, -849132, -1068549, -1206640
};

static const int32_t zetas_inv[N_PRIME] = {
449533, -1332708, 724227, -1298588, 353619, 756766, -146762, -273971, 762457, 217773, 670529, 855205, -557407, -855205, -339709, 482795,
-87625, 1332708, 136852, -1114935, 719009, -443383, 1220363, 273971, 62571, -1087418, -418217, -419476, 98777, -1226465, -1284304, 1193594,
700972, 540966, -1041936, 1031667, -838617, -1031667, 714379, -32871, 114514, 1087418, -612950, -546452, 702549, 612191, -1038359, -1193594,
163780, -859842, 1136891, -1092242, 1489139, -483803, 1124106, 71564, -241389, -774010, -184968, 799818, -1290745, -799818, -1136019, -412239,
-1389328, 859842, -1284340, 1391301, 821743, -292424, -71658, -71564, -916944, 76093, -462717, 686708, 1152655, 625971, 120873, 1108725,
-884483, 1432923, -1212037, 236258, 1046066, -236258, 1400143, -1290457, -1335985, -76093, 1374821, 1509016, 421287, 922966, 190176, -1108725,
-56479, 999472, 1157151, 43158, 75270, 1482296, 65593, -1109168, 31764, -1089533, -679924, 619026, -152884, -619026, -1388411, 373128,
1305047, -999472, -671999, -90061, -106628, 662184, 742229, 1109168, 473355, -770339, 973927, 1184271, 639925, 1232509, 1234264, 57810,
787303, -150960, 510118, -131705, 335581, 131705, -1189732, 1290319, 1076620, 770339, 668928, -921299, 577318, 1052566, 852936, -57810,
-1288067, -771538, 467996, 727428, 44826, 255899, 12296, 298714, 1102136, 959388, -653780, 1422570, 196637, -1422570, -940910, 554613,
-229333, 771538, 976251, 187850, -1106208, -875155, -811443, -298714, 885966, 1274910, 18384, 1126122, -1170664, -67782, -658282, -950557,
-1502727, -954259, 612217, -1007387, -321503, 1007387, 851433, -1018339, -1356713, -1274910, -971569, 320651, -987543, 118735, -338944, 950557,
-1332708, 869534, -273971, 1043385, -1298588, -1176706, -855205, 690882, -1114935, -950096, 482795, 1242365, -1087418, -1242365, 1193594, -485824,
-419476, -869534, -1031667, -80562, -546452, -739403, -32871, -690882, -859842, -592820, 71564, 942066, -1092242, -610714, -799818, 1237374,
1391301, -623605, -412239, -748366, 76093, 748366, 1108725, 626660, 686708, 592820, -236258, -1216425, 1509016, 193700, -1290457, -1237374,
999472, 1237739, -1109168, 1135274, 43158, -688234, -619026, -1038706, -90061, -1405401, 373128, -851304, -770339, 851304, 57810, 1298213,
1184271, -1237739, 131705, -167662, -921299, 283970, 1290319, 1038706, -771538, -1267696, 298714, -940876, 727428, -202450, -1422570, -561962,
187850, 1169182, 554613, 22289, 1274910, -22289, -950557, -764412, 1126122, 1267696, 1007387, -98514, 320651, -918587, -1018339, 561962,
869534, -654845, 690882, 1253171, 1043385, -344601, -1242365, 1336474, -80562, -1381607, -485824, 1198047, -592820, -1198047, 1237374, 991873,
942066, 654845, 748366, 988701, -1216425, -573935, 626660, -1336474, 1237739, 787566, -1038706, 888508, 1135274, -1112937, 851304, 384107,
-167662, -946508, 1298213, 1342887, -1267696, -1342887, -561962, -728830, -940876, -787566, -22289, -158942, -98514, -793758, -764412, -384107,
-654845, -831042, 1336474, 149679, 1253171, -131829, -1198047, 259660, 988701, 796061, 991873, 1337288, 787566, -1337288, 384107, 127831,
888508, 831042, -1342887, -34981, -158942, 1486967, -728830, -259660, -831042, 849132, 259660, -664741, 149679, 749964, -1337288, 1068549,
-34981, 1258397, 127831, 985567, 849132, -985567, 1068549, -1206640, -664741, -849132, -985567, -917624, -917624, 320826, -1206640, -1068549,
-56479, 999472, 31764, -1089533, -671999, -90061, 1305047, -999472, 335581, 131705, 577318, 1052566, 973927, 1184271, 510118, -131705,
885966, 1274910, -1502727, -954259, -971569, 320651, -1356713, -1274910, 12296, 298714, 44826, 255899, -940910, 554613, -811443, -298714,
62571, -1087418, 700972, 540966, -612950, -546452, 114514, 1087418, -146762, -273971, 353619, 756766, -339709, 482795, 1220363, 273971,
-1290745, -799818, 821743, -292424, 1136891, -1092242, -184968, 799818, 120873, 1108725, 1152655, 625971, 1400143, -1290457, 190176, -1108725,
999472, 1237739, -90061, -1405401, 131705, -167662, 1184271, -1237739, 1274910, -22289, 320651, -918587, 298714, -940876, 554613, 22289,
-1087418, -1242365, -546452, -739403, -273971, 1043385, 482795, 1242365, -799818, 1237374, -1092242, -610714, 1108725, 626660, -1290457, -1237374,
1237739, 787566, -167662, -946508, -22289, -158942, -940876, -787566, -1242365, 1336474, 1043385, -344601, 1237374, 991873, 626660, -1336474,
787566, -1337288, -158942, 1486967, 1336474, 149679, 991873, 1337288, -1337288, 1068549, 149679, 749964, 1068549, -1206640, -1206640, -1068549,
62571, 114514, -339709, 500381, 120873, 190176, 821743, -1321859, 335581, 510118, 31764, -1048107, -971569, 636460, 44826, 129467,
-1087418, 482795, 1108725, -292424, 131705, -1089533, 320651, 255899, -1242365, 626660, -167662, -918587, 1336474, -946508, 149679, 749964,
-1087418, 482795, 1108725, -292424, 131705, -1089533, 320651, 255899, -1242365, 626660, -167662, -918587, 1336474, -946508, 149679, 749964,
-1242365, 626660, -167662, -918587, 1336474, -946508, 149679, 749964, 1336474, -946508, 149679, 749964, 149679, 749964, -1613198, 1613198
};

/*************************************************
* Name:        poly_reduction
*
* Description: Switching back to Zq[x]/(x^n-x-1).
**************************************************/
static void poly_reduction(int16_t r[KYBER_N], const int32_t a[N_PRIME])
{
  unsigned int i;
  int32_t tmp[257];

  tmp[0] = a[0] + a[257];
  for(i = 1; i < 256; i++)
    tmp[i] = a[i + 256] + a[i + 257] + a[i];
  tmp[256] = a[256] + a[512];

  for(i = 0; i < 257; ++i)
      r[i] = reduce32to16(tmp[i]);
}

/*************************************************
* Name:        poly_padding
*
* Description: zero padding.
**************************************************/
static void poly_padding(int32_t r[N_PRIME], const int16_t a[KYBER_N])
{
  unsigned int i;
  for(i=0;i<257;i++){
    r[i]=a[i];
  }
  for(i=257;i<576;i++){
    r[i]=0;
  }

}

/*************************************************
* Name:        ntt_naive
*
* Description: Inplace number-theoretic transform (NTT) in R_Q.
**************************************************/
static void ntt_naive(int32_t r[N_PRIME]) {
  unsigned int len, start, j, k;
  int32_t t, zeta;
  int32_t tb, tc, tpho, zeta1, zeta2;

  // Radix-2
  k = 1;
  for(len = 288; len >= 9; len >>= 1) {
    for(start = 0; start < 576; start = j + len) {
      zeta = zetas[k++];
      for(j = start; j < start + len; j++) {
        t = fQmul(zeta, r[j + len]);
        r[j + len] = r[j] - t;
        r[j] = r[j] + t;
      }
    }
  }
  
  // Radix-3
  len = 3;
  for (start = 0; start < 576; start += 3 * len)
  {
    zeta1 = zetas[k++];
    zeta2 = zetas[k++];
    for (j = start; j < start + len; j++)
    {
      tb = fQmul(zeta1, r[j + len]);
      tc = fQmul(zeta2, r[j + len + len]);
      tpho = fQmul(ROOT_3, tb - tc);

      r[j + len + len] = r[j] - tb - tpho;
      r[j + len] = r[j] - tc + tpho;
      r[j] = r[j] + tb + tc;
    }
  }

  // Radix-3
  len = 1;
  for (start = 0; start < 576; start += 3 * len)
  {
    zeta1 = zetas[k++];
    zeta2 = zetas[k++];
    for (j = start; j < start + len; j++)
    {
      tb = fQmul(zeta1, r[j + len]);
      tc = fQmul(zeta2, r[j + len + len]);
      tpho = fQmul(ROOT_3, tb - tc);

      r[j + len + len] = r[j] - tb - tpho;
      r[j + len] = r[j] - tc + tpho;
      r[j] = r[j] + tb + tc;
    }
  }
}

/*************************************************
* Name:        invtntt_naive
*
* Description: Inplace inverse number-theoretic transform in R_Q.
**************************************************/
static void invtntt_naive(int32_t r[N_PRIME]) {
  unsigned int start, len, j, k;
  int32_t t, zeta;
  int32_t tb, tc, tpho, zeta1, zeta2;

  k = 0;

  // Radix-3
  len = 1;
  for (start = 0; start < 576; start += 3 * len)
  {
    zeta1 = zetas_inv[k++];
    zeta2 = zetas_inv[k++];
    for (j = start; j < start + len; j++)
    {
      tpho = fQmul(ROOT_3, r[j + len] - r[j + len + len]);
      tb = (r[j] - r[j + len] - tpho);
      tc = (r[j] - r[j + len + len] + tpho);

      r[j] = (r[j] + r[j + len] + r[j + len + len]);
      r[j + len] = fQmul(zeta1, tb);
      r[j + len + len] = fQmul(zeta2, tc);
    }
  }

  // Radix-3
  len = 3;
  for (start = 0; start < 576; start += 3 * len)
  {
    zeta1 = zetas_inv[k++];
    zeta2 = zetas_inv[k++];
    for (j = start; j < start + len; j++)
    {
      tpho = fQmul(ROOT_3, r[j + len] - r[j + len + len]);
      tb = (r[j] - r[j + len] - tpho);
      tc = (r[j] - r[j + len + len] + tpho);

      r[j] = (r[j] + r[j + len] + r[j + len + len]);
      r[j + len] = fQmul(zeta1, tb);
      r[j + len + len] = fQmul(zeta2, tc);
    }
  }
  
  // Radix-2
  for(len = 9; len <= 288; len <<= 1) {
    for(start = 0; start < 576; start = j + len) {
      zeta = zetas_inv[k++];
      for(j = start; j < start + len; j++) {
        t = r[j];
        r[j] = t + r[j + len];
        r[j + len] = t - r[j + len];
        r[j + len] = fQmul(zeta, r[j + len]);
      }
    }
  }

  for(j = 0; j < 288; j++)
    r[j] = fQmul(r[j], zetas_inv[575]);
}


/*************************************************
* Name:        ntt
*
* Description: The complete extended NTT.
**************************************************/
void ntt(int32_t a_star[N_PRIME], int16_t a[KYBER_N]){
  poly_padding(a_star, a);
  ntt_naive(a_star);
}

/*************************************************
* Name:        invntt
*
* Description: The complete inverse extended NTT.
**************************************************/
void invntt(int16_t a[KYBER_N], int32_t a_star[N_PRIME]){
  invtntt_naive(a_star);
  poly_reduction(a, a_star);
}

/*************************************************
* Name:        poly_pointwise
*
* Description: Multiplication in Zq[X]/(x-zeta)
**************************************************/
void poly_pointwise(int32_t c[N_PRIME], const int32_t a[N_PRIME], const int32_t b[N_PRIME])
{
  unsigned int i;
  for(i = 0; i < 576; ++i)
    c[i] = fQmul(a[i], b[i]);
}


